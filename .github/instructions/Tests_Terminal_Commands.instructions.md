---
applyTo: '**'
name: 'Tests_Terminal_Commands'
description: 'Единая инструкция по запуску pytest в Windows: проверенные команды, настройки и решения всех проблем.'
---

## Обязательное правило

**Всегда** создавайте и запускайте тесты для любых изменений в коде.
**Рекомендация:** Используйте флаг `--tb=short` (например `python -m pytest -q --tb=short`), чтобы сократить длинные трассировки и уменьшить объём вывода, это также уменьшает вероятность переполнения контекста и отказа функционала `tool:run_in_terminal`.

## Проблемы и решения

### Проблема 1: Агент не получает ответ из терминала (run_in_terminal возвращает пустоту)
- **Решение**: использовать PowerShell с `Out-Host` (наиболее надёжно) или применить `terminal_last_command` как резервный метод для cmd и Select-String.

### Проблема 2: `Out-File` неприемлем для live-вывода
- **Решение**: использовать только как резервный вариант для анализа полного вывода.

### Проблема 3: `Select-Object` обрезает вывод и не подходит для pytest
- **Решение**: использовать `Select-String` для фильтрации, избегать `Select-Object -First/-Last` для pytest вывода. Для ограничения строк использовать `Select-String` с паттернами или `Out-File` с последующим `Get-Content -TotalCount`.

### Проблема 4: Переполнение контекста DEBUG/INFO логами приложения
- **Решение**: добавлена фикстура pytest в `tests/conftest.py`, подавляющая логи уровня INFO/DEBUG.

### Проблема 5: Escaped sequences (╬яЎш , ╦ютъюёЄ№) в выводе без UTF-8
- **Причина**: PowerShell по умолчанию использует кодировку CP866, которая отображает кириллицу как псевдографику.
- **Решение**: ОБЯЗАТЕЛЬНО устанавливать UTF-8 кодировку перед запуском pytest с логами. Без установки UTF-8 кириллица в логах будет отображаться как escaped sequences даже при использовании `Select-Object`.

### Проблема 6: get_terminal_output возвращает "Invalid terminal ID"
- **Причина**: Неправильный ID терминала (строковый "powershell" вместо UUID).
- **Решение**: Использовать UUID из результата `run_in_terminal(..., isBackground=True)`. Работает только для фоновых команд.

### Проблема 7: Проблемы с shell escaping/quoting при `python -c`
- **Причина**: Сложности с экранированием кавычек и специальных символов в терминале.
- **Решение**: Использовать `mcp_pylance_mcp_s_pylanceRunCodeSnippet` для выполнения Python кода напрямую без терминала. Требует явной установки UTF-8 для кириллицы:
  ```python
  import sys, io
  sys.stdout = io.TextIOWrapper(sys.stdout.buffer, encoding='utf-8')
  ```
