# Практические рекомендации и чек-листы

## Чек-лист: Создание промпта с нуля

### Этап 1: Определение задачи

- [ ] Четко сформулирована конечная цель
- [ ] Определена целевая аудитория результата
- [ ] Установлены критерии успеха (как оценить качество результата)
- [ ] Идентифицированы входные данные
- [ ] Определен желаемый формат вывода

### Этап 2: Базовая структура

- [ ] Определена роль AI (если необходимо)
- [ ] Написаны четкие инструкции
- [ ] Добавлен необходимый контекст
- [ ] Указан формат вывода
- [ ] Добавлены ограничения (что НЕ делать)

### Этап 3: Улучшение

- [ ] Добавлены примеры (если задача сложная)
- [ ] Использованы подходящие делимитеры (XML/Markdown)
- [ ] Проверена консистентность терминологии
- [ ] Убраны противоречия в инструкциях
- [ ] Добавлены граничные случаи

### Этап 4: Тестирование

- [ ] Протестировано на типичных примерах
- [ ] Протестировано на граничных случаях
- [ ] Проверена консистентность результатов
- [ ] Измерены метрики (точность, время, стоимость)
- [ ] Собрана обратная связь

### Этап 5: Оптимизация

- [ ] Устранены выявленные проблемы
- [ ] Оптимизирована длина промпта
- [ ] Улучшена формулировка инструкций
- [ ] Добавлены примеры для проблемных случаев
- [ ] Финальная проверка качества

---

## Чек-лист: Отладка проблемного промпта

### Диагностика проблемы

- [ ] Точно определена проблема (какой результат вместо ожидаемого)
- [ ] Собраны примеры неправильных выходов
- [ ] Определена частота проблемы (всегда/иногда/редко)
- [ ] Проверена консистентность ошибок

### Системный анализ

- [ ] Проверены противоречия в инструкциях
- [ ] Проверено соответствие примеров инструкциям
- [ ] Оценена ясность формулировок
- [ ] Проверена полнота контекста
- [ ] Убедиться что формат вывода четко определен

### Пошаговое улучшение

- [ ] Упрощен промпт до минимума (проверка базовой функциональности)
- [ ] Постепенно добавляются элементы обратно
- [ ] После каждого изменения проводится тестирование
- [ ] Документируются результаты каждого изменения
- [ ] Применяются только изменения, улучшающие результат

### Специфические исправления

- [ ] Для проблем с форматом: усилены инструкции по формату + примеры
- [ ] Для галлюцинаций: добавлены ограничения на источники информации
- [ ] Для непоследовательности: добавлены конкретные примеры
- [ ] Для непонимания контекста: реструктурирован или расширен контекст
- [ ] Для игнорирования инструкций: усилена формулировка + перенос в конец промпта

---

## Рекомендации по длине промпта

### Оптимальная длина для разных задач

**Простые задачи (классификация, извлечение)**

- Системный промпт: 100-300 токенов
- User промпт: 50-200 токенов
- Примеры: 0-2 примера

**Средней сложности (анализ, генерация контента)**

- Системный промпт: 300-800 токенов
- User промпт: 100-500 токенов
- Примеры: 2-5 примеров

**Сложные задачи (агенты, мультишаговые)**

- Системный промпт: 800-2000 токенов
- User промпт: варьируется
- Примеры: 3-10 примеров

### Как сокращать избыточные промпты

1. Удалите повторяющиеся инструкции
2. Объедините похожие правила
3. Используйте примеры вместо длинных описаний
4. Удалите очевидные инструкции
5. Замените многословные объяснения краткими формулировками

### Когда расширять промпт

- Результаты непредсказуемы → добавить примеры
- Модель игнорирует инструкции → усилить формулировку
- Ошибки в граничных случаях → добавить специфические инструкции
- Неправильный формат → добавить детальное описание формата + пример

---

## Распространенные ошибки и решения

### Ошибка 1: Модель не следует инструкциям

**Проблема:** AI игнорирует части промпта

**Причины:**

- Инструкции слишком длинные или запутанные
- Противоречия между разными частями промпта
- Инструкции размыты или неоднозначны

**Решения:**

- Упростите формулировки
- Проверьте на противоречия
- Используйте императивные глаголы ("Сделай X", а не "Ты можешь сделать X")
- Поместите критичные инструкции в конец промпта (Claude 4.x)
- Добавьте конкретные примеры желаемого поведения

### Ошибка 2: Непостоянные результаты

**Проблема:** Разные результаты для одинаковых входов

**Причины:**

- Недостаточная специфичность инструкций
- Отсутствие примеров
- Высокая temperature

**Решения:**

- Добавьте больше конкретных деталей
- Используйте few-shot примеры
- Снизьте temperature до 0.0-0.3
- Укажите точный формат вывода
- Используйте структурированные выходы (JSON schema)

### Ошибка 3: Галлюцинации

**Проблема:** Модель придумывает информацию

**Причины:**

- Недостаточный контекст
- Просьба о информации вне знаний модели
- Отсутствие инструкций о признании незнания

**Решения:**

- Явно укажите: "Используй только предоставленную информацию"
- Добавьте: "Если не знаешь ответа, скажи 'Не знаю'"
- Предоставьте весь необходимый контекст
- Для фактов - используйте web search или RAG
- Попросите модель цитировать источники

### Ошибка 4: Неправильный формат вывода

**Проблема:** Вывод не соответствует желаемому формату

**Причины:**

- Неточное описание формата
- Отсутствие примеров
- Конфликт между инструкциями и примерами

**Решения:**

- Покажите точный пример формата
- Используйте структурированные выходы (JSON schema для GPT)
- Явно укажите: "ТОЛЬКО JSON, без дополнительного текста"
- Для Claude: используйте префиллинг для начала нужного формата
- Добавьте валидацию формата в постобработке

### Ошибка 5: Слишком короткие или длинные ответы

**Проблема:** Длина ответа не соответствует ожиданиям

**Решения:**

- Укажите конкретную длину: "150-200 слов" или "3-5 параграфов"
- Покажите пример желаемой длины
- Для коротких ответов: "Ответь максимально кратко, одним предложением"
- Для детальных: "Предоставь исчерпывающий анализ, охватывающий все аспекты"

### Ошибка 6: Модель слишком осторожна или отказывается

**Проблема:** Модель избегает выполнения легитимной задачи

**Решения:**

- Предоставьте контекст о легитимности задачи
- Переформулируйте запрос более нейтрально
- Разбейте задачу на меньшие шаги
- Укажите явно, что задача этична и легальна (если так)

---

## Оптимизация для разных метрик

### Оптимизация точности

**Техники:**

1. Используйте self-consistency (несколько ответов + выбор)
2. Добавьте Chain of Thought
3. Увеличьте количество примеров
4. Добавьте валидацию в промпт ("Проверь свой ответ на...")
5. Используйте ensembling (разные промпты → согласование)

**Пример промпта для самопроверки:**

```
После формулировки ответа, выполни следующие проверки:
1. Все ли требования учтены?
2. Есть ли противоречия в ответе?
3. Корректен ли формат?
4. Есть ли фактические ошибки?

Если находишь проблемы - исправь их перед финальным ответом.
```

### Оптимизация скорости

**Техники:**

1. Сокращайте промпт до необходимого минимума
2. Используйте более быстрые модели для простых задач
3. Кешируйте повторяющиеся части промпта (Claude Prompt Caching)
4. Используйте batch API для множества запросов
5. Parallel tool calls для независимых операций

### Оптимизация стоимости

**Техники:**

1. Используйте менее дорогие модели где возможно (Haiku вместо Sonnet)
2. Сокращайте длину промптов
3. Используйте prompt caching для повторяющихся элементов
4. Batch processing для некритичных по времени задач
5. Фильтруйте входы перед отправкой к дорогой модели

**Каскадная стратегия:**

```
1. Простая классификация → Haiku (дешево)
2. Если confidence < 0.8 → Sonnet (средне)
3. Если критичная задача → Opus (дорого)
```

---

## Паттерны для специфических задач

### Паттерн: Извлечение структурированных данных

```xml
<instructions>
Извлеки следующие данные из текста. Если информация отсутствует, используй null.
</instructions>

<output_schema>
{
  "field1": "тип и описание",
  "field2": "тип и описание"
}
</output_schema>

<extraction_rules>
1. Извлекай только явную информацию
2. Не делай предположений
3. Сохраняй оригинальные формулировки
4. Используй null для отсутствующих полей
</extraction_rules>

<examples>
[Минимум 2 примера с разными случаями]
</examples>

<input>
[Текст для обработки]
</input>

Верни ТОЛЬКО JSON без дополнительного текста.
```

### Паттерн: Многошаговый анализ

```xml
<task>Проанализируй [объект] используя следующие шаги:</task>

<analysis_steps>
Шаг 1: [первый этап анализа]
- Опиши что ты видишь
- Выдели ключевые элементы

Шаг 2: [второй этап]
- Проанализируй взаимосвязи
- Выяви паттерны

Шаг 3: [третий этап]
- Сформулируй выводы
- Дай рекомендации

После каждого шага делай паузу и убеждайся что выполнил его полностью перед переходом к следующему.
</analysis_steps>

<output_format>
# Шаг 1: [название]
[результаты]

# Шаг 2: [название]
[результаты]

# Шаг 3: [название]
[результаты]

# Итоговые выводы
[финальные выводы]
</output_format>
```

### Паттерн: Креативная генерация с ограничениями

```xml
<creative_task>
Создай [тип контента] на тему [тема]
</creative_task>

<mandatory_elements>
Обязательно включи:
- [элемент 1]
- [элемент 2]
- [элемент 3]
</mandatory_elements>

<constraints>
Ограничения:
- Не используй: [запрещенные элементы]
- Стиль: [желаемый стиль]
- Тон: [желаемый тон]
- Длина: [количество слов/параграфов]
</constraints>

<inspiration>
Вдохновляйся следующим, но создай оригинальное произведение:
[референсы или примеры стиля]
</inspiration>

<quality_criteria>
Результат должен быть:
- [критерий качества 1]
- [критерий качества 2]
- [критерий качества 3]
</quality_criteria>
```

---

## Тестирование промптов

### Создание тестового набора

**Категории тестовых случаев:**

1. **Happy Path (70%)** - Типичные примеры
   - Стандартные входы
   - Ожидаемое использование
   - Средняя сложность

2. **Edge Cases (20%)** - Граничные случаи
   - Минимальные входы
   - Максимальные входы
   - Пустые или null значения
   - Необычные, но валидные комбинации

3. **Error Cases (10%)** - Проблемные случаи
   - Невалидные входы
   - Противоречивая информация
   - Неполные данные
   - Потенциально вредоносные входы

### Метрики оценки

**Качественные метрики:**

- Корректность (правильный ответ)
- Полнота (все аспекты учтены)
- Релевантность (соответствие задаче)
- Консистентность (стабильность результатов)
- Формат (соответствие требованиям)

**Количественные метрики:**

- Точность (accuracy)
- Precision и Recall (для классификации)
- F1-score
- Latency (время ответа)
- Cost (токены/стоимость)

### Процесс A/B тестирования промптов

```
1. Baseline промпт → собрать метрики на тестовом наборе
2. Создать вариант промпта с улучшением
3. Тестировать на том же наборе
4. Сравнить метрики:
   - Если улучшение ≥ 5% → принять
   - Если ухудшение → откатить
   - Если незначительные изменения → продолжить оптимизацию
5. Повторять процесс
```

---

## Версионирование и документация промптов

### Что документировать

```markdown
# Промпт: [Название] v[Версия]

## Назначение
[Для чего используется этот промпт]

## Модель
- Оптимизировано для: [модель и версия]
- Протестировано на: [список моделей]

## Параметры
- Temperature: [значение]
- Max tokens: [значение]
- Top P: [значение]
- Другие параметры: [значения]

## Входные переменные
- `{variable1}`: [описание, тип, ограничения]
- `{variable2}`: [описание, тип, ограничения]

## Ожидаемый формат вывода
[Описание или пример]

## Известные ограничения
- [ограничение 1]
- [ограничение 2]

## История изменений
### v1.2 (2024-01-15)
- Добавлено: [что добавлено]
- Исправлено: [что исправлено]
- Метрики: accuracy 85% → 92%

### v1.1 (2024-01-10)
- Изменения и метрики

### v1.0 (2024-01-05)
- Первоначальная версия
- Базовые метрики
```

---

## Финальный чек-лист перед деплоем

- [ ] Промпт протестирован на репрезентативном наборе данных
- [ ] Метрики качества соответствуют требованиям
- [ ] Стоимость одного запроса приемлема
- [ ] Latency соответствует SLA
- [ ] Обработаны граничные случаи
- [ ] Документация обновлена
- [ ] Версия промпта зафиксирована
- [ ] Настроен мониторинг в продакшене
- [ ] Есть план отката (предыдущая версия промпта)
- [ ] Команда обучена использованию промпта
