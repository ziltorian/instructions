# Продвинутые техники Prompt Engineering

## Специфика для различных моделей

### Claude (Anthropic) - Особенности

#### Точное следование инструкциям

Claude 4.x модели очень точно следуют инструкциям:

- Будьте максимально явными в требованиях
- Указывайте, что делать, а не только чего избегать
- Модель буквально интерпретирует каждую инструкцию

**Пример:**

```
❌ Плохо: "Не используй markdown"
✅ Хорошо: "Твой ответ должен состоять из гладко текущих прозаических параграфов без markdown форматирования"
```

#### XML теги для Claude

Claude особенно хорошо работает с XML:

```xml
<instructions>
  <task>Основная задача</task>
  <constraints>
    <constraint>Ограничение 1</constraint>
    <constraint>Ограничение 2</constraint>
  </constraints>
  <output_format>
    Требуемый формат вывода
  </output_format>
</instructions>

<examples>
  <example id="1">
    <input>Входные данные</input>
    <output>Ожидаемый результат</output>
  </example>
</examples>
```

#### Префиллинг ответа

Уникальная возможность Claude:

```python
messages = [
    {"role": "user", "content": "Напиши JSON с данными пользователя"},
    {"role": "assistant", "content": "{"}  # Префиллинг
]
```

#### Extended Thinking (Claude Opus 4.5)

```
<thinking_guidance>
После получения результатов инструментов, внимательно проанализируй их качество и определи оптимальные следующие шаги, прежде чем продолжать. Используй свое мышление для планирования и итераций на основе новой информации.
</thinking_guidance>
```

### GPT-4.1 (OpenAI) - Особенности

#### Агентные workflow

GPT-4.1 оптимизирован для агентных задач:

```
<persistence_reminder>
Ты — агент. Продолжай работу до полного решения запроса пользователя перед завершением хода. Завершай ход только когда уверен, что проблема решена.
</persistence_reminder>

<tool_calling_reminder>
Если не уверен в содержимом файла или структуре кодовой базы, используй свои инструменты для чтения файлов и сбора информации. НЕ УГАДЫВАЙ и не придумывай ответ.
</tool_calling_reminder>

<planning_reminder>
Ты ДОЛЖЕН подробно планировать перед каждым вызовом функции и детально размышлять о результатах предыдущих вызовов. НЕ выполняй весь процесс только через вызовы функций — это может ухудшить твою способность решать проблемы.
</planning_reminder>
```

#### Работа с инструментами

- ВСЕГДА используйте поле `tools` в API
- Не вставляйте описания инструментов вручную в промпт
- Давайте четкие названия и описания инструментов
- Используйте поле "description" для параметров

#### Индуцированное планирование

```
Подумай внимательно шаг за шагом о том, какие документы нужны для ответа на запрос. Затем выведи НАЗВАНИЕ и ID каждого документа. Затем отформатируй ID в список.
```

#### Длинный контекст (1M токенов)

- Размещай инструкции в начале И в конце контекста
- Используй XML или специальный формат для документов:

  ```
  ID: 1 | TITLE: The Fox | CONTENT: The quick brown fox...
  ```

- Избегай JSON для больших коллекций документов

### Общие продвинутые техники

## 1. Агентное поведение

### Управление состоянием

```xml
<state_management>
  <current_state>
    {
      "progress": "50%",
      "completed_tasks": ["task1", "task2"],
      "next_steps": ["task3", "task4"],
      "context_summary": "Краткое описание текущего состояния"
    }
  </current_state>
</state_management>
```

### Мультиконтекстные workflow

1. Используй разные промпты для первого контекстного окна
2. Создавай тесты в структурированном формате (JSON)
3. Настраивай вспомогательные инструменты (скрипты инициализации)
4. Используй Git для отслеживания состояния

### Инкрементальный прогресс

```
<incremental_work>
Это очень длинная задача, поэтому полезно четко спланировать работу. Рекомендуется потратить весь контекст вывода на работу над задачей — просто убедись, что не закончится контекст с существенной незафиксированной работой. Продолжай работать систематически, пока не завершишь задачу.
</incremental_work>
```

## 2. Tool Use оптимизация

### Параллельные вызовы инструментов

```
<parallel_tool_calls>
Если планируешь вызвать несколько инструментов и между вызовами нет зависимостей, выполни все независимые вызовы параллельно. Приоритизируй одновременные вызовы инструментов везде, где действия можно выполнить параллельно, а не последовательно.

Например, при чтении 3 файлов, запусти 3 вызова инструмента параллельно для одновременного чтения всех файлов. Максимизируй использование параллельных вызовов для увеличения скорости и эффективности.

Однако, если некоторые вызовы зависят от предыдущих для получения зависимых значений, таких как параметры, НЕ вызывай эти инструменты параллельно, а вызывай последовательно. Никогда не используй заполнители и не угадывай отсутствующие параметры в вызовах инструментов.
</parallel_tool_calls>
```

### Управление детальностью

```
<verbosity_control>
После завершения задачи с использованием инструментов, предоставь краткое резюме выполненной работы.
</verbosity_control>
```

## 3. Форматирование и стиль вывода

### Минимизация markdown

```
<avoid_excessive_markdown>
При написании отчетов, документов, технических объяснений, анализа или любого длинного контента пиши четкой, текучей прозой, используя полные параграфы и предложения. Используй стандартные разрывы параграфов для организации.

Резервируй markdown в основном для:
- `inline code`
- Блоков кода (```...```)
- Простых заголовков (###)

Избегай использования **bold** и *italics*.

НЕ используй упорядоченные списки (1. ...) или неупорядоченные списки (*) если только:
a) ты представляешь действительно дискретные элементы, где формат списка — лучший вариант
b) пользователь явно запрашивает список или рейтинг

Вместо перечисления элементов с буллетами или цифрами, включай их естественно в предложения. НИКОГДА не выводи серию излишне коротких маркированных пунктов.
</avoid_excessive_markdown>
```

### Соответствие стилю промпта

Стиль вашего промпта может влиять на стиль ответа модели:

- Если хотите прозу без markdown — используйте прозу в промпте
- Если нужен код — покажите примеры кода
- Формат промпта задает тон выводу

## 4. Исследование и информационный сбор

### Структурированное исследование

```
<research_strategy>
Ищи эту информацию структурированным образом:

1. Разработай несколько конкурирующих гипотез по мере сбора данных
2. Отслеживай уровни уверенности в заметках о прогрессе
3. Регулярно критикуй свой подход и план
4. Обновляй дерево гипотез или файл исследовательских заметок
5. Разбивай сложную исследовательскую задачу систематически

Убедись, что проверяешь информацию из нескольких источников.
</research_strategy>
```

### Критерии успеха

```
<success_criteria>
Исследование считается успешным когда:
- Получены ответы из минимум 3 независимых источников
- Информация непротиворечива или противоречия объяснены
- Покрыты основные аспекты вопроса
- Идентифицированы пробелы в знаниях
</success_criteria>
```

## 5. Оркестрация субагентов

### Естественная делегация (Claude 4.5)

```
<subagent_orchestration>
Делегируй субагентам только когда задача явно выигрывает от отдельного агента с новым контекстным окном.

Признаки необходимости субагента:
- Задача требует специализированных знаний
- Нужен свежий контекст без истории
- Параллельная обработка независимых подзадач
- Изолированная среда выполнения
</subagent_orchestration>
```

## 6. Работа с изображениями и multimodal

### Crop tool для улучшения vision

```
<vision_optimization>
При анализе изображений с мелкими деталями:
1. Используй crop tool для увеличения интересующих областей
2. Анализируй секции изображения отдельно
3. Синтезируй результаты из всех регионов
4. Верифицируй находки на полном изображении
</vision_optimization>
```

### Обработка видео

```
Для анализа видео:
1. Разбей видео на ключевые кадры (каждые N секунд)
2. Проанализируй каждый кадр отдельно
3. Отследи изменения между кадрами
4. Составь временную последовательность событий
```

## 7. Минимизация галлюцинаций

### Верификация перед ответом

```
<investigation_before_answering>
Никогда не строй предположений о коде, который не открыл. Если пользователь ссылается на конкретный файл, ты ДОЛЖЕН прочитать файл перед ответом.

Убедись, что исследуешь и читаешь релевантные файлы ПЕРЕД ответом на вопросы о кодовой базе. Никогда не делай утверждений о коде до исследования, если только не уверен в правильном ответе — давай обоснованные ответы без галлюцинаций.
</investigation_before_answering>
```

## 8. Frontend и UI дизайн

### Избегание "AI slop" эстетики

```
<frontend_aesthetics>
Ты склонен к созданию генерических выводов. Во frontend дизайне это создает то, что пользователи называют "AI slop" эстетикой. Избегай этого: создавай креативные, отличительные интерфейсы, которые удивляют и радуют.

Фокус на:
- **Типографика**: Выбирай красивые, уникальные, интересные шрифты. Избегай генерических шрифтов как Arial и Inter; выбирай отличительные варианты.
- **Цвет и тема**: Придерживайся связной эстетики. Используй CSS переменные для консистентности. Доминирующие цвета с резкими акцентами превосходят робкие, равномерно распределенные палитры.
- **Движение**: Используй анимации для эффектов и микро-взаимодействий. CSS-only решения для HTML. Motion библиотека для React.
- **Фоны**: Создавай атмосферу и глубину вместо сплошных цветов. Слои CSS градиентов, геометрические паттерны, контекстуальные эффекты.

Избегай:
- Переиспользованные шрифты (Inter, Roboto, Arial)
- Клише цветовые схемы (особенно фиолетовые градиенты)
- Предсказуемые макеты и компоненты
- Дизайн без характера

Интерпретируй креативно и делай неожиданные выборы. Варьируй между светлыми и темными темами, разными шрифтами, разными эстетиками.
</frontend_aesthetics>
```

## 9. Code Quality

### Избегание переинжиниринга (Claude Opus 4.5)

```
<avoid_overengineering>
Избегай чрезмерного инжиниринга. Делай только запрошенные или явно необходимые изменения. Держи решения простыми и сфокусированными.

НЕ добавляй функции, не рефактори код, не делай "улучшения" сверх запрошенного. Исправление бага не требует очистки окружающего кода. Простая функция не нуждается в дополнительной конфигурируемости.

НЕ добавляй обработку ошибок, резервные варианты или валидацию для сценариев, которые не могут произойти. Доверяй внутреннему коду и гарантиям фреймворка. Валидируй только на границах системы.

НЕ создавай хелперы, утилиты или абстракции для одноразовых операций. НЕ проектируй для гипотетических будущих требований.

Правильное количество сложности — минимум, необходимый для текущей задачи.
</avoid_overengineering>
```

### Общее решение vs хардкод

```
<general_solutions>
Пиши качественное, универсальное решение, используя стандартные доступные инструменты. НЕ создавай вспомогательные скрипты или обходные пути.

Реализуй решение, которое корректно работает для всех валидных входов, а не только для тестовых случаев. НЕ хардкодь значения или создавай решения, работающие только для конкретных тестовых входов.

Фокусируйся на понимании требований проблемы и реализации правильного алгоритма. Тесты существуют для верификации корректности, а не для определения решения.

Если задача невыполнима или тесты некорректны, проинформируй меня вместо обхода. Решение должно быть надежным, поддерживаемым и расширяемым.
</general_solutions>
```

## 10. Контроль поведения

### Проактивность vs Консервативность

```
<!-- Для проактивного действия -->
<default_to_action>
По умолчанию реализуй изменения вместо их только предложения. Если намерение пользователя неясно, выведи наиболее полезное вероятное действие и действуй, используя инструменты для выяснения недостающих деталей вместо угадывания.
</default_to_action>

<!-- Для консервативного подхода -->
<do_not_act_before_instructions>
НЕ переходи к реализации или изменению файлов, если явно не проинструктирован делать изменения. Когда намерение пользователя неоднозначно, по умолчанию предоставляй информацию, проводи исследование и давай рекомендации вместо действий.
</do_not_act_before_instructions>
```

## 11. Специальные возможности моделей

### Самоидентификация модели

```
<model_identity>
Ассистент — это Claude, созданный Anthropic. Текущая модель — Claude Sonnet 4.5.

При необходимости LLM, по умолчанию используй Claude Sonnet 4.5, если пользователь не просит иного. Точная строка модели для Claude Sonnet 4.5: claude-sonnet-4-5-20250929
</model_identity>
```

### Чувствительность к "thinking" (Claude Opus 4.5)

```
<!-- Избегай слова "think" когда extended thinking отключен -->
Вместо "think" используй: consider, believe, evaluate, analyze, determine
```
